name: Build macOS Installer ISO/DMG image

on:
  workflow_dispatch:
    inputs:
      macos_version:
        description: 'Select a macOS version to build'
        required: true
        type: choice
        options:
          - 'Sequoia'
          - 'Sonoma'
          - 'Ventura'
          - 'Monterey'
          - 'Big Sur'
          - 'Catalina'
          - 'Mojave'
          - 'High Sierra'
          - 'Sierra'
          - 'El Capitan'
          - 'Yosemite'
          - 'Mavericks'
          - 'Mountain Lion'
          - 'Lion'
      image_format:
        description: 'Select image format'
        required: true
        type: choice
        options:
          - 'iso'
          - 'dmg'

jobs:
  build-macos-installer-image:
    runs-on: macos-15-intel
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: System Information
        run: |
          echo "===== SYSTEM INFO ====="
          sw_vers
          uname -m
          sysctl -n machdep.cpu.brand_string
          echo "RAM:"
          top -l 1 | grep PhysMem
          echo "Disk:"
          df -h /

      - name: Build macOS image
        id: build
        run: |
          echo "===== BUILD STEP ====="
          echo "macOS Version  : ${{ github.event.inputs.macos_version }}"
          echo "Image format   : ${{ github.event.inputs.image_format }}"

          if [ "${{ github.event.inputs.image_format }}" = "iso" ]; then
            sudo bash mkmaciso "${{ github.event.inputs.macos_version }}" iso
            ISO=$(ls *.iso | head -n1)
            echo "image_path=$ISO" >> $GITHUB_OUTPUT
          else
            sudo bash mkmaciso "${{ github.event.inputs.macos_version }}" dmg
            DMG=$(ls *.dmg.img | head -n1)
            echo "image_path=$DMG" >> $GITHUB_OUTPUT
          fi

      - name: Verify installer image (modern macOS)
        run: |
          echo "===== VERIFICATION STEP ====="

          IMAGE="${{ steps.build.outputs.image_path }}"
          echo "Image selected for verification: $IMAGE"

          mkdir -p /private/tmp/macos_verify
          echo "Mounting image..."
          hdiutil attach "$IMAGE" -mountpoint /private/tmp/macos_verify -nobrowse

          echo "Listing root of installer image:"
          ls -lah /private/tmp/macos_verify

          echo "Searching Install macOS app..."
          APP=$(find /private/tmp/macos_verify -maxdepth 2 -type d -name "Install macOS*.app" | head -n1)

          if [ -z "$APP" ]; then
            echo "❌ Install macOS app NOT found"
            hdiutil detach /private/tmp/macos_verify
            exit 1
          fi

          echo "Found installer app:"
          echo "$APP"

          echo "Checking SharedSupport.dmg..."
          if [ ! -f "$APP/Contents/SharedSupport/SharedSupport.dmg" ]; then
            echo "❌ SharedSupport.dmg missing"
            hdiutil detach /private/tmp/macos_verify
            exit 1
          fi

          echo "✅ FULL macOS installer verified"
          hdiutil detach /private/tmp/macos_verify

      - name: Upload ISO artifact
        if: github.event.inputs.image_format == 'iso'
        uses: actions/upload-artifact@v5
        with:
          name: macos-installer-iso
          path: ./*.iso
          compression-level: 0
          retention-days: 7

      - name: Upload DMG artifact
        if: github.event.inputs.image_format == 'dmg'
        uses: actions/upload-artifact@v5
        with:
          name: macos-installer-dmg
          path: ./*.dmg.img
          compression-level: 0
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "===== SUMMARY =====" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "macOS Version : ${{ github.event.inputs.macos_version }}" >> $GITHUB_STEP_SUMMARY
          echo "Format        : ${{ github.event.inputs.image_format }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Installer verified as FULL macOS installer" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use this image for:" >> $GITHUB_STEP_SUMMARY
          echo "- VMware Workstation / Fusion" >> $GITHUB_STEP_SUMMARY
          echo "- VirtualBox" >> $GITHUB_STEP_SUMMARY
          echo "- Proxmox / QEMU" >> $GITHUB_STEP_SUMMARY
